---
import { Icon } from 'astro-icon/components';
import type { HTMLAttributes } from 'astro/types';
import type { ImageMetadata } from 'astro';
import { Picture } from 'astro:assets';
import { generateUniqueID } from '#util.ts';

type Props = {
    src?: ImageMetadata;
    alt?: string;
    size: number;
    aspectRatio?: number;
    enforceAspectRatio?: boolean;
    responsive?: boolean;
    fullscreenModal?: boolean;
    placeholder?: string;
    class?: string;
    innerClass?: string;
} & HTMLAttributes<'div'>;

const {
    src, 
    alt = '', 
    size, 
    aspectRatio = 1, 
    enforceAspectRatio = true, 
    responsive = false, 
    fullscreenModal = false, 
    placeholder = 'mdi:image-area', 
    class: classes = '', 
    innerClass = '', 
    ...rest
} = Astro.props;

const modalID = `modal-image-fullscreen-${generateUniqueID()}`;

const formatStyle = (style: string | astroHTML.JSX.CSSProperties | null | undefined) => {
    if (style === undefined || style === null) {
        return '';
    }
    if (typeof style === 'string') {
        return style;
    }
    return Object.entries(style).map(([key, value]) => `${key}: ${value};`).join(' ');
};
---
<div
    class="flex items-center justify-center overflow-hidden bg-zinc-300 relative"
    style={formatStyle({
        'aspect-ratio': enforceAspectRatio || src === undefined ? aspectRatio : 'auto',
        'max-width': responsive ? '100%' : `${size}px`,
    }) + formatStyle(rest.style)}
    class:list={classes} {...rest}
>
    {
        src !== undefined
            ? <Picture 
                {src}
                {alt}
                style={formatStyle({
                    'aspect-ratio': enforceAspectRatio || src === undefined ? aspectRatio : 'auto',
                })}
                class="object-cover"
                layout="full-width" 
                width={size}
                height={size / src.width * src.height} 
                class:list={innerClass}
            />
            : <Icon name={placeholder} class="text-zinc-700" width="75%" height={`${(1 / aspectRatio) * 75}%`} class:list={innerClass}/>
    }

    {
        fullscreenModal && src !== undefined
            && (
                <button 
                    onclick={`document.getElementById('${modalID}').showModal();`}
                    class="absolute bottom-2 right-2 btn btn-soft rounded-full shadow-md p-2 opacity-80 hover:opacity-100"
                >
                    <Icon name="mdi:fullscreen" class="size-5" />
                </button>
            )
    }
</div>
{
    fullscreenModal && src !== undefined
    && <dialog id={modalID} class="modal image-modal p-5 md:p-20">
        <div class="modal-box p-0 relative w-full max-w-none max-h-full">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-soft rounded-full absolute right-5 top-5 opacity-80 hover:opacity-100">
                    <Icon name="mdi:close" class="size-5" />
                </button>
            </form>
            <Picture {src} {alt} layout="fixed" class="w-full h-auto"/>
        </div>
        <form method="dialog" class="modal-backdrop -m-5 md:-m-20">
            <button>close</button>
        </form>
    </dialog>
}