---
import { Icon } from 'astro-icon/components';
import {
    type CollectionEntry,
    type ReferenceDataEntry,
    getEntries,
} from 'astro:content';
import Image from '#components/Image.astro';

// Get from content
type Props = {
    publications: CollectionEntry<'publications'>[];
};

const { publications } = Astro.props;
publications.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Use map instead of object to keep insertion order
const publicationsByYear = new Map<number, typeof publications>();
publications.forEach((pub) => {
    const year = pub.data.date.getFullYear();
    if (!publicationsByYear.has(year)) {
        publicationsByYear.set(year, []);
    }
    publicationsByYear.get(year)!.push(pub);
});
const peopleReferences = Array.from(
    new Set(publications.flatMap((pub) => (pub.data.people ?? []))),
);
const peopleMap = Object.fromEntries(
    (await getEntries(peopleReferences)).map((person) => [person.id, person]),
);
const person = (reference: ReferenceDataEntry<'people', string>) => peopleMap[reference.id]!;
---
{publications.length === 0
    ? <span class="text-base-content/50 text-lg font-medium">No publications here yet.</span>
    : <div class="timeline flex flex-col gap-5">
        {
            Array.from(publicationsByYear.entries()).map(([year, pubs]) => <section class="timeline-section">
                <div class="timeline-point">
                    <Icon name="mdi:book-open-page-variant"/>
                </div>
                <h3 class="mb-2 text-lg font-semibold">{year}</h3>
                <div class="list bg-base-200 rounded-box shadow-md">
                    {
                        pubs.map((publication) => (
                            <a href={`/publications/${publication.id}`}>
                                <article class="list-row hover:bg-base-300 bg-base-200 lg:justify-betweeny-between flex flex-col gap-x-2 gap-y-1 lg:flex-row lg:items-center">
                                    <div class="shrink grow">
                                        <h4 class="text-xs font-semibold">{publication.data.title}</h4>
                                        <span class="text-xs font-medium opacity-60">{publication.data.authors}</span>
                                    </div>
                                    <div class="flex shrink-0 items-center justify-between gap-2 bg-inherit">
                                        {
                                            publication.data.award !== undefined
                                                && <div class="badge badge-primary tooltip px-0.75" data-tip={publication.data.award}>
                                                    <Icon name="mdi:trophy" class="size-4"/>
                                                </div>
                                        }
                                        <div class="badge badge-primary badge-outline">{publication.data.venue}</div>
                                        <div class="flex -space-x-6 bg-inherit">
                                            {
                                                (publication.data.people ?? []).map((ref, i) => (
                                                    <Image src={person(ref).data.photo} size={48} placeholder="mdi:account" class="max-w-[48px] rounded-full bg-inherit! p-[3px]" innerClass="rounded-full" style={`z-index: ${20 - i};`}/>
                                                ))
                                            }
                                        </div>
                                    </div>
                                </article>
                            </a>
                        ))
                    }
                </div>
            </section>)
        }
    </div>
}

<style>
    @reference '#styles/app.css';

    .timeline {
        --timeline-line-width: 0.25rem;
        --timeline-padding: 1.75rem;
        --timeline-point-size: 1.5rem;
        --timeline-point-icon-size: 0.75rem;
        --timeline-header-height: 1.75rem;
        @apply ml-4 relative;
    }

    .timeline:before {
        @apply bg-primary/50 absolute;
        content: '';
        top: calc(var(--timeline-point-size) / 2);
        bottom: 0;
        left: 0;
        width: var(--timeline-line-width);
    }

    .timeline-section {
        @apply relative ps-7;
    }

    .timeline-point {
        @apply bg-primary text-primary-content absolute rounded-full;
        left: calc((var(--timeline-line-width) - var(--timeline-point-size)) / 2);
        top: calc((var(--timeline-header-height) - var(--timeline-point-size)) / 2);
        padding: calc((var(--timeline-point-size) - var(--timeline-point-icon-size)) / 2);
    }

    .timeline-point * {
        width: var(--timeline-point-icon-size);
        height: var(--timeline-point-icon-size);
    }
</style>
